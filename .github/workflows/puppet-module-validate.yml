name: Validate Puppet Module

on:
  workflow_call:
    inputs:
      puppet-version:
        description: 'Puppet version to use for validation'
        required: false
        type: string
        default: '8'
      ruby-version:
        description: 'Ruby version to use'
        required: false
        type: string
        default: '3.2'
      pdk-version:
        description: 'PDK version to use'
        required: false
        type: string
        default: 'latest'
      skip-pdk:
        description: 'Skip PDK validation (use individual tools instead)'
        required: false
        type: boolean
        default: false
      strict-commits:
        description: 'Fail build on non-conventional commits (default: false, only warns)'
        required: false
        type: boolean
        default: false
      working-directory:
        description: 'Working directory for the module'
        required: false
        type: string
        default: '.'

jobs:
  validate:
    name: Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for conventional commits check

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ inputs.ruby-version }}
          bundler-cache: false

      - name: Install PDK
        if: ${{ !inputs.skip-pdk }}
        run: |
          wget https://apt.puppet.com/puppet-tools-release-jammy.deb
          sudo dpkg -i puppet-tools-release-jammy.deb
          sudo apt-get update
          sudo apt-get install -y pdk
        working-directory: ${{ inputs.working-directory }}

      - name: Install Puppet and tools
        run: |
          gem install puppet -v '~> ${{ inputs.puppet-version }}'
          gem install puppet-lint
          gem install metadata-json-lint
        working-directory: ${{ inputs.working-directory }}

      - name: Install yamllint
        run: |
          sudo apt-get install -y yamllint
        working-directory: ${{ inputs.working-directory }}

      - name: Install markdownlint
        run: |
          npm install -g markdownlint-cli
        working-directory: ${{ inputs.working-directory }}

      - name: YAML Lint
        run: |
          if [ -f .yamllint ]; then
            yamllint .
          else
            yamllint -d "{extends: default, rules: {line-length: {max: 120}, comments: {min-spaces-from-content: 1}}}" .
          fi
        continue-on-error: false
        working-directory: ${{ inputs.working-directory }}

      - name: JSON Lint (metadata.json)
        run: |
          if [ -f metadata.json ]; then
            metadata-json-lint metadata.json
          else
            echo "‚ö†Ô∏è  No metadata.json found - skipping"
            exit 0
          fi
        working-directory: ${{ inputs.working-directory }}

      - name: Markdown Lint
        run: |
          if compgen -G "*.md" > /dev/null; then
            markdownlint *.md || true
          else
            echo "No markdown files found - skipping"
          fi
        continue-on-error: true  # Don't fail on markdown issues
        working-directory: ${{ inputs.working-directory }}

      - name: PDK Validation
        if: ${{ !inputs.skip-pdk }}
        run: |
          pdk validate --parallel
        working-directory: ${{ inputs.working-directory }}

      - name: Puppet Syntax Check
        if: ${{ inputs.skip-pdk }}
        run: |
          find . -name '*.pp' -exec puppet parser validate {} \;
        working-directory: ${{ inputs.working-directory }}

      - name: Puppet Lint
        if: ${{ inputs.skip-pdk }}
        run: |
          if compgen -G "manifests/*.pp" > /dev/null || compgen -G "**/*.pp" > /dev/null; then
            puppet-lint \
              --fail-on-warnings \
              --no-documentation-check \
              --no-autoloader_layout-check \
              manifests/
          else
            echo "No Puppet manifests found - skipping"
          fi
        working-directory: ${{ inputs.working-directory }}

      - name: Check Conventional Commits
        run: |
          echo "Checking for conventional commit format..."
          # Get commits since last tag, or all commits if no tags
          if git describe --tags --abbrev=0 2>/dev/null; then
            LAST_TAG=$(git describe --tags --abbrev=0)
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s")
          else
            COMMITS=$(git log --pretty=format:"%s")
          fi

          # Check if we're on a PR
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            echo "üìã Checking commits in PR..."
            COMMITS=$(git log origin/${{ github.event.pull_request.base.ref }}..HEAD --pretty=format:"%s")
          fi

          VALID=true
          WARNINGS=0
          while IFS= read -r commit; do
            # Skip merge commits
            if [[ "$commit" =~ ^Merge\ .+ ]]; then
              echo "‚ÑπÔ∏è  Skipping merge commit: $commit"
              continue
            fi

            # Check conventional commits format
            if [[ ! "$commit" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?!?:\ .+ ]]; then
              if [ "${{ inputs.strict-commits }}" = "true" ]; then
                echo "‚ùå Invalid commit message: $commit"
              else
                echo "‚ö†Ô∏è  Non-conventional commit: $commit"
              fi
              echo "   Expected format: type(scope): description"
              echo "   Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
              WARNINGS=$((WARNINGS + 1))
              if [ "${{ inputs.strict-commits }}" = "true" ]; then
                VALID=false
              fi
            fi
          done <<< "$COMMITS"

          if [ "$WARNINGS" -gt 0 ]; then
            echo ""
            echo "üí° Example: feat(init): add initial module structure"
            if [ "${{ inputs.strict-commits }}" = "true" ]; then
              echo "‚ö†Ô∏è  Strict mode enabled - failing build due to $WARNINGS non-conventional commit(s)"
            else
              echo "‚ÑπÔ∏è  Found $WARNINGS non-conventional commit(s) - continuing (set strict-commits: true to fail)"
            fi
          fi

          if [ "$VALID" = false ]; then
            exit 1
          else
            if [ "$WARNINGS" -eq 0 ]; then
              echo "‚úÖ All commits follow Conventional Commits format"
            else
              echo "‚úÖ Validation passed with warnings"
            fi
          fi
        working-directory: ${{ inputs.working-directory }}

      - name: Validation Summary
        if: success()
        run: |
          echo "‚úÖ All validations passed!"
          echo ""
          echo "Completed checks:"
          echo "  - YAML Lint"
          echo "  - JSON Lint (metadata.json)"
          echo "  - Markdown Lint"
          if [ "${{ inputs.skip-pdk }}" = "false" ]; then
            echo "  - PDK Validation (includes Puppet syntax, puppet-lint, etc.)"
          else
            echo "  - Puppet Syntax Check"
            echo "  - Puppet Lint"
          fi
          echo "  - Conventional Commits"
